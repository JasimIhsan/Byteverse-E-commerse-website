<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Byteverse | User-management</title>
        <link rel="stylesheet" href="/css/admin/dashboard.css" />
        <style>
  
        </style>
    </head>

    <body>
        <div class="dashboard-container">
            <!-- Sidebar -->
            <aside class="unique-sidebar">
                <div class="unique-sidebar-header">
                    <h2>Byteverse</h2>
                </div>
                <ul class="unique-sidebar-menu">
                    <li class="active"><a href="#">Dashboard</a></li>
                    <li><a href="/admin/user-management">Users</a></li>
                    <li><a href="/admin/product-management">Products</a></li>
                    <li><a href="/admin/order-management">Orders</a></li>
                    <li><a href="/admin/category-management">Categories</a></li>
                    <li><a href="/admin/coupon-management">Coupon</a></li>
                    <li><a href="/admin/offer-management">Offers</a></li>
                    <li><a href="#">Support</a></li>
                    <li><a href="#">Settings</a></li>
                </ul>
            </aside>
            
            <!-- Main Content -->
            <div class="product-list-container">
                <h1>Dashboard</h1>
        
                <!-- Breadcrumbs -->
                <nav class="breadcrumbs">
                    <a href="/admin/dashboard">Dashboard</a>
                    <span>&gt;</span>
                </nav>

                <div class="card_badge " style="margin-top: 16px;">
                   
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div class="flex flex-wrap gap-4">
                            <!-- Time Filter Options -->
                            <select id="time-filter" onchange="handleFilterChange()" style="padding: 5px 10px; border-radius: 4px; border: 1px solid #ddd;">
                                <option value="all" <%= timeFilter === 'all' ? 'selected' : '' %>>All</option>
                                <option value="today" <%= timeFilter === 'today' ? 'selected' : '' %>>Today</option>
                                <option value="week" <%= timeFilter === 'week' ? 'selected' : '' %>>Weekly</option>
                                <option value="month" <%= timeFilter === 'month' ? 'selected' : '' %>>Monthly</option>
                                <option value="custom" <%= timeFilter === 'custom' ? 'selected' : '' %>>Custom Date</option>
                            </select>
        
                            <!-- Custom Date Range Picker -->
                            <div id="custom-date-range" style='display: none;'>
                                <input type="date" id="start-date" value="<%= startDate || '' %>" />
                                <input type="date" id="end-date" value="<%= endDate || '' %>" />
                                <button onclick="generateReport()" style="padding: 5px 10px;">Apply</button>
                            </div>
                        </div>
                        <div class="mt-4 flex " style="flex-direction: column;">
                            <h2 class="card-title" style="margin: 0px; font-size: 16px;">Download Sales Report</h2>
                            <div style="margin-top: 5px;">
                                <button style="height: 35px;" onclick="downloadReport('pdf')">Download PDF</button>
                                <button style="height: 35px;" onclick="downloadReport('excel')">Download Excel</button>
                                
                            </div>
                        </div>
                    </div>
                </div>
        
                <div class="grid-badge grid-badge-cols-3 mb-4">
                    <div class="card_badge">
                        <h2 class="card-title">Overall Sales Count</h2>
                        <div class="stat-value" id="sales-count"><%= overallSalesCount %></div>
                    </div>
                    <div class="card_badge">
                        <h2 class="card-title">Overall Order Amount</h2>
                        <div class="stat-value" id="order-amount">$<%= overallOrderAmount.toLocaleString() %></div>
                    </div>
                    <div class="card_badge">
                        <h2 class="card-title">Overall Discount</h2>
                        <div class="stat-value" id="overall-discount">$<%= overallDiscount.toLocaleString() %></div>
                    </div>
                </div>
        
                <div class="grid mb-4">
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">Best Selling Products</h2>
                            <p class="card-description">Top 10 products (monthly sales)</p>
                        </div>
                        <div class="card-content">
                            <canvas id="bestProductsChart"></canvas>
                        </div>
                    </div>
        
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">Best Selling Categories</h2>
                            <p class="card-description">Top 10 categories (monthly sales)</p>
                        </div>
                        <div class="card-content">
                            <canvas id="bestCategoriesChart"></canvas>
                        </div>
                    </div>
        
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">Year-over-Year Comparison</h2>
                            <p class="card-description">Products, Categories, and Brands performance</p>
                        </div>
                        <div class="card-content">
                            <canvas id="yearlyComparisonChart"></canvas>
                        </div>
                    </div>
        
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">Top 5 Brands Market Share</h2>
                            <p class="card-description">Based on monthly sales</p>
                        </div>
                        <div class="card-content">
                            <canvas id="brandsMarketPieChart"></canvas>
                        </div>
                    </div>
                </div>

                <div class="decorative-divider">
                    
                    <div class="dividery" style="width: 100%;"></div>

                </div>
                
        
                <!-- Sales Report Section -->
                <div class="card_badge mb-4" style="margin-top: 16px;">
                    <h2 class="card-title" style="font-size: 1.8rem; font-weight: bold; color: #333; margin-bottom: 20px;">
                        ðŸ“Š Sales Report
                    </h2>
                    
                </div>
        
                <div class="card_badge mb-4">
                    <h2 class="card-title">Sales Report Graph</h2>
                    <canvas id="sales-chart"></canvas>
                </div>
        
                <div class="card_badge">
                    <h2 class="card-title">Detailed Sales Report</h2>
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Total Orders</th>
                                <th>Total Amount</th>
                                <th>Coupon Discount</th>
                                <th>Offer Discount</th>
                                <th>Total Discount</th>
                            </tr>
                        </thead>
                        <tbody>
                            <% salesData.forEach(data => { %>
                            <tr>
                                <td><%= data.date %></td>
                                <td><%= data.totalOrders %></td>
                                <td>$<%= data.totalAmount.toFixed(2) %></td>
                                <td>$<%= data.totalCouponDiscount.toFixed(2) %></td>
                                <td>$<%= data.totalOfferDiscount.toFixed(2) %></td>
                                <td>$<%= (data.totalCouponDiscount + data.totalOfferDiscount).toFixed(2) %></td>
                            </tr>
                            <% }); %>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- <script src="/javascripts/admin/product.js"></script> -->
        <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

        <script>

            function handleFilterChange() {
                const filter = document.getElementById('time-filter').value;
                const customDateRange = document.getElementById('custom-date-range');

                if (filter === 'custom') {
                    customDateRange.style.display = 'block';
                } else {
                    customDateRange.style.display = 'none';
                    generateReport();
                }
            }

            async function generateReport() {
                const timeFilter = document.getElementById("time-filter").value;
                const response = await fetch(`/admin/dashboard?timeFilter=${timeFilter}`);
                const data = await response.text();
                document.body.innerHTML = data;
            }

            
        </script>
        <script>
            // Assume these variables are set from your server-side rendering
            const labels = <%- JSON.stringify(labels) %>;
            const ordersData = <%- JSON.stringify(ordersData) %>;
            const amountData = <%- JSON.stringify(amountData) %>;
            const discountData = <%- JSON.stringify(discountData) %>; // You may need to define this in your server-side data
        
            const ctx = document.getElementById('sales-chart').getContext('2d');
        
            // Check if the data arrays have been populated correctly
            console.log('Labels:', labels);
            console.log('Orders Data:', ordersData);
            console.log('Amount Data:', amountData);
            console.log('Discount Data:', discountData); // Ensure this is defined
        
            let chart;
        
            // Function to initialize the chart with data
            function initChart() {
                if (labels.length > 0 && ordersData.length > 0 && amountData.length > 0) {
                    chart = new Chart(ctx, {
                        type: 'line', // Change to 'bar' or other types as needed
                        data: {
                            labels: labels,
                            datasets: [
                                {
                                    label: 'Total Orders',
                                    data: ordersData,
                                    borderColor: 'rgba(75, 192, 192, 1)',
                                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                                    borderWidth: 2,
                                },
                                {
                                    label: 'Total Amount',
                                    data: amountData,
                                    borderColor: 'rgba(255, 99, 132, 1)',
                                    backgroundColor: 'rgba(255, 99, 132, 0.2)',
                                    borderWidth: 2,
                                },
                                {
                                    label: 'Discount',
                                    data: discountData, // Add discount data
                                    borderColor: 'rgba(255, 205, 86, 1)',
                                    backgroundColor: 'rgba(255, 205, 86, 0.2)',
                                    borderWidth: 2,
                                },
                            ],
                        },
                        options: {
                            responsive: true,
                            scales: {
                                y: {
                                    beginAtZero: true,
                                },
                            },
                        },
                    });
                } else {
                    console.error("No data available for the chart.");
                }
            }
        
            // Function to update the chart based on the selected time filter
            function updateChart() {
                const timeFilter = document.getElementById("time-filter").value;
                let currentData;
        
                switch (timeFilter) {
                    case "day":
                        currentData = dailySalesData; // Ensure these arrays are defined
                        break;
                    case "week":
                        currentData = weeklySalesData;
                        break;
                    case "month":
                        currentData = monthlySalesData;
                        break;
                    default:
                        currentData = [];
                }
        
                const labels = currentData.map(item => item.date || item.week || item.month);
                const orders = currentData.map(item => item.orders);
                const amounts = currentData.map(item => item.amount);
                const discounts = currentData.map(item => item.discount || 0); // Use 0 if discount is not available
        
                // Update chart data
                if (chart) {
                    chart.data.labels = labels;
                    chart.data.datasets[0].data = orders;
                    chart.data.datasets[1].data = amounts;
                    chart.data.datasets[2].data = discounts;
                    chart.update();
                }
            }
        
            // Event listener for the time filter
            document.getElementById("time-filter").addEventListener("change", function() {
                updateChart();
            });
        
            // Initial render
            initChart();
        
            document.addEventListener("DOMContentLoaded", function () {
                window.downloadReport = function (format) {
                    const timeFilterElement = document.getElementById('time-filter');
                    if (!timeFilterElement) {
                        console.error("Time filter dropdown not found!");
                        return;
                    }
                    
                    const timeFilter = timeFilterElement.value;
        
                    window.location.href = `/admin/dashboard/download-report?format=${format}&timeFilter=${timeFilter}`;
                };
            });
        </script>
        <script>
            // Generate dummy data functions
            function generateData(prefix, count) {
                return Array.from({ length: count }, (_, i) => ({
                    name: `${prefix} ${i + 1}`,
                    sales: Math.floor(Math.random() * 1000) + 100,
                }));
            }

            // Initial data
            const monthlyData = {
                products: generateData("Product", 10),
                categories: generateData("Category", 10),
                brands: generateData("Brand", 5),
            };

            const yearlyData = {
                products: monthlyData.products.map((item) => ({ ...item, sales: item.sales * 12 })),
                categories: monthlyData.categories.map((item) => ({ ...item, sales: item.sales * 12 })),
                brands: monthlyData.brands.map((item) => ({ ...item, sales: item.sales * 12 })),
            };

            // Create charts
            const bestProductsChart = new Chart(document.getElementById("bestProductsChart"), {
                type: "bar",
                data: {
                    labels: monthlyData.products.map((item) => item.name),
                    datasets: [{ label: "Sales", data: monthlyData.products.map((item) => item.sales), backgroundColor: "#8884d8" }],
                },
            });

            const bestCategoriesChart = new Chart(document.getElementById("bestCategoriesChart"), {
                type: "bar",
                data: {
                    labels: monthlyData.categories.map((item) => item.name),
                    datasets: [{ label: "Sales", data: monthlyData.categories.map((item) => item.sales), backgroundColor: "#82ca9d" }],
                },
            });

            const yearlyComparisonChart = new Chart(document.getElementById("yearlyComparisonChart"), {
                type: "line",
                data: {
                    labels: ["2020", "2021", "2022", "2023", "2024"],
                    datasets: [
                        { label: "Products", data: [1000, 1500, 2000, 2500, 3000], borderColor: "#8884d8", fill: false },
                        { label: "Categories", data: [800, 1200, 1500, 1800, 2200], borderColor: "#82ca9d", fill: false },
                        { label: "Brands", data: [500, 700, 1000, 1300, 1600], borderColor: "#ffc658", fill: false },
                    ],
                },
            });

            const brandsMarketPieChart = new Chart(document.getElementById("brandsMarketPieChart"), {
                type: "pie",
                data: {
                    labels: monthlyData.brands.map((item) => item.name),
                    datasets: [{ data: monthlyData.brands.map((item) => item.sales), backgroundColor: ["#0088FE", "#00C49F", "#FFBB28", "#FF8042", "#8884D8"] }],
                },
            });

            // Handle time frame change
            document.getElementById("timeFrameSelector").addEventListener("change", function () {
                const data = this.value === "monthly" ? monthlyData : yearlyData;

                bestProductsChart.data.datasets[0].data = data.products.map((item) => item.sales);
                bestProductsChart.update();

                bestCategoriesChart.data.datasets[0].data = data.categories.map((item) => item.sales);
                bestCategoriesChart.update();

                brandsMarketPieChart.data.datasets[0].data = data.brands.map((item) => item.sales);
                brandsMarketPieChart.update();
            });
        </script>
    </body>
</html>


const getAdminDashboard = async (req, res) => {
    try {
        const { search = "", timeFilter = "all" } = req.query;

        let startDate = new Date();
        const endDate = new Date();

        // Handle different time filter conditions
        if (timeFilter === "today") {
            startDate.setDate(startDate.getDate() - 1);
        } else if (timeFilter === "week") {
            startDate.setDate(startDate.getDate() - 7);
        } else if (timeFilter === "month") {
            startDate.setMonth(startDate.getMonth() - 1);
        } else if (timeFilter === "all") {
            startDate = new Date("1970-01-01"); // Set a very early date to include all records
        }

        const salesData = await Order.aggregate([
            {
                $match: {
                    orderDate: {
                        $gte: startDate,
                        $lt: endDate,
                    },
                },
            },
            {
                $group: {
                    _id: {
                        $dateToString: {
                            format: timeFilter === "today" ? "%Y-%m-%d" : timeFilter === "week" ? "%Y-%U" : "%Y-%m",
                            date: "$orderDate",
                        },
                    },
                    totalOrders: { $sum: 1 },
                    totalAmount: { $sum: "$total" },
                    totalCouponDiscount: { $sum: "$couponDiscount" },
                    totalOfferDiscount: { $sum: "$offerDiscount" },
                    totalDiscount: {
                        $sum: { $add: ["$couponDiscount", "$offerDiscount"] },
                    },
                },
            },
            {
                $project: {
                    date: "$_id",
                    totalOrders: 1,
                    totalAmount: 1,
                    totalCouponDiscount: 1,
                    totalOfferDiscount: 1,
                    totalDiscount: 1,
                    _id: 0,
                },
            },
            {
                $sort: {
                    date: 1,
                },
            },
        ]);

        const overallSalesCount = salesData.reduce((acc, item) => acc + item.totalOrders, 0);
        const overallOrderAmount = salesData.reduce((acc, item) => acc + item.totalAmount, 0);
        const overallCouponDiscount = salesData.reduce((acc, item) => acc + item.totalCouponDiscount, 0);
        const overallOfferDiscount = salesData.reduce((acc, item) => acc + item.totalOfferDiscount, 0);
        const overallDiscount = overallCouponDiscount + overallOfferDiscount;

        // Data for chart
        const labels = salesData.map((item) => item.date);
        const ordersData = salesData.map((item) => item.totalOrders);
        const amountData = salesData.map((item) => item.totalAmount);
        const discountData = salesData.map((item) => item.totalDiscount); // Add discount data

        res.render("admin/dashboard", {
            search,
            salesData,
            overallSalesCount,
            overallOrderAmount,
            overallCouponDiscount,
            overallOfferDiscount,
            overallDiscount,
            labels,
            ordersData,
            amountData,
            discountData,
            timeFilter,
            startDate,
            endDate,
        });
    } catch (error) {
        console.error("Error from rendering admin dashboard: \n", error);
        res.status(500).send("Internal Server Error");
    }
};

const apiAdminDashboard = async (req, res) => {
    try {
        const { timeFilter = "all" } = req.query;

        let startDate = new Date();
        const endDate = new Date();

        // Handle different time filter conditions
        if (timeFilter === "today") {
            startDate.setDate(startDate.getDate() - 1);
        } else if (timeFilter === "week") {
            startDate.setDate(startDate.getDate() - 7);
        } else if (timeFilter === "month") {
            startDate.setMonth(startDate.getMonth() - 1);
        } else if (timeFilter === "all") {
            startDate = new Date("1970-01-01"); // Include all records
        }

        // Aggregate sales data
        const salesData = await Order.aggregate([
            {
                $match: {
                    orderDate: {
                        $gte: startDate,
                        $lt: endDate,
                    },
                },
            },
            {
                $group: {
                    _id: {
                        $dateToString: {
                            format: timeFilter === "today" ? "%Y-%m-%d" : timeFilter === "week" ? "%Y-%U" : "%Y-%m",
                            date: "$orderDate",
                        },
                    },
                    totalOrders: { $sum: 1 },
                    totalAmount: { $sum: "$total" },
                    totalCouponDiscount: { $sum: "$couponDiscount" },
                    totalOfferDiscount: { $sum: "$offerDiscount" },
                    totalDiscount: { $sum: { $add: ["$couponDiscount", "$offerDiscount"] } },
                },
            },
            {
                $project: {
                    date: "$_id",
                    totalOrders: 1,
                    totalAmount: 1,
                    totalCouponDiscount: 1,
                    totalOfferDiscount: 1,
                    totalDiscount: 1,
                    _id: 0,
                },
            },
            {
                $sort: {
                    date: 1,
                },
            },
        ]);

        // Summary calculations
        const overallSalesCount = salesData.reduce((acc, item) => acc + item.totalOrders, 0);
        const overallOrderAmount = salesData.reduce((acc, item) => acc + item.totalAmount, 0);
        const overallCouponDiscount = salesData.reduce((acc, item) => acc + item.totalCouponDiscount, 0);
        const overallOfferDiscount = salesData.reduce((acc, item) => acc + item.totalOfferDiscount, 0);
        const overallDiscount = overallCouponDiscount + overallOfferDiscount;

        // Prepare response data
        const tableData = salesData.map((item) => ({
            date: item.date,
            orders: item.totalOrders,
            amount: item.totalAmount,
            coupons: item.totalCouponDiscount,
            discount: item.totalDiscount,
        }));

        const chartData = {
            labels: salesData.map((item) => item.date),
            orders: salesData.map((item) => item.totalOrders),
            amounts: salesData.map((item) => item.totalAmount),
            discounts: salesData.map((item) => item.totalDiscount),
        };

        res.json({
            overallSalesCount,
            overallOrderAmount,
            overallCouponDiscount,
            overallOfferDiscount,
            overallDiscount,
            tableData,
            chartData,
        });
    } catch (error) {
        console.error("Error from rendering admin dashboard: \n", error);
        res.status(500).json({ message: "Internal Server Error" });
    }
};

no give me the correct contreolleer