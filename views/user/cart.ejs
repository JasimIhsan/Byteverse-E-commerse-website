<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
        <title>Cart | Byteverse E-commerce</title>
        <!-- Favicon and styles -->
        <link rel="stylesheet" href="/assets/css/bootstrap.min.css" />
        <link rel="stylesheet" href="/assets/css/style.css" />
        <link rel="stylesheet" href="/css/user/main.css" />
        <!-- Include SweetAlert2 CSS & JS -->
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" />
        <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.all.min.js"></script>
    </head>

    <body>
        <div class="page-wrapper">
            <%- include('partials/header.ejs') %>

            <main class="main">
                <!-- Cart page header -->
                <div class="page-header text-center" style="background-image: url('/assets/images/page-header-bg.jpg'); margin-top: 65px">
                    <div class="container">
                        <h1 class="page-title">Shopping Cart<span>Shop</span></h1>
                    </div>
                </div>
                <div class="page-content">
                    <div class="cart">
                        <div class="container">
                            <div class="row">
                                <div class="col-lg-9">
                                    <!-- Display success or error messages -->
                                    <% if (error_msg) { %>
                                    <div class="error-message" id="error"><%= error_msg %></div>
                                    <% } %> <% if (success_msg) { %>
                                    <div class="success-message" id="error"><%= success_msg %></div>
                                    <% } %>

                                    <!-- Cart table -->
                                    <table class="table table-cart table-mobile">
                                        <thead>
                                            <tr>
                                                <th>Product</th>
                                                <th>Price</th>
                                                <th>Quantity</th>
                                                <th>Total</th>
                                                <th></th>
                                            </tr>
                                        </thead>

                                        <tbody>
                                            <% if (cartItems.length > 0) { %> <% cartItems.forEach(item => { %>
                                            <tr data-product-id="<%= item.id %>">
                                                <td class="product-col">
                                                    <div class="product">
                                                        <figure class="product-media">
                                                            <a href="#">
                                                                <img src="/<%= item.image[0] %>" alt="Product image" />
                                                            </a>
                                                        </figure>
                                                        <h3 class="product-title"><a href="#"><%= item.name %></a></h3>
                                                    </div>
                                                </td>
                                                <td class="price-col">$<%= item.price.toFixed(2) %></td>
                                                <td class="quantity-col">
                                                    <div class="cart-product-quantity">
                                                        <input type="number" class="form-control quantity-input" value="<%= item.quantity %>" min="1" max="<%= item.stock %>" step="1" data-stock="<%= item.stock %>" />
                                                    </div>
                                                </td>
                                                <td class="total-col" id="product-subtotal">$<%= subtotal.toFixed(2) %></td>
                                                <td class="remove-col">
                                                    <button type="button" class="btn-remove" data-product-id="<%= item.id %>">
                                                        <i class="icon-close"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                            <% }) %> <% } else { %>
                                            <tr>
                                                <td colspan="5" class="text-center">Your cart is empty.</td>
                                            </tr>
                                            <% } %>
                                        </tbody>
                                    </table>
                                </div>

                                <!-- Cart total summary -->
                                <aside class="col-lg-3">
                                    <div class="summary summary-cart">
                                        <h3 class="summary-title">Cart Total</h3>
                                        <table class="table table-summary">
                                            <tbody>
                                                <tr class="summary-subtotal">
                                                    <td>Subtotal:</td>
                                                    <td id="subtotal">$<%= subtotal.toFixed(2) %></td>
                                                </tr>
                                                <tr class="summary-shipping">
                                                    <td>Shipping:</td>
                                                    <td id="shipping-message">&nbsp;</td>
                                                </tr>
                                                <tr class="summary-total">
                                                    <td>Total:</td>
                                                    <td id="total">$<%= total.toFixed(2) %></td>
                                                </tr>
                                            </tbody>
                                        </table>
                                        <% if (cartItems.length > 0) { %>
                                        <a href="/<%= user._id %>/cart/checkout" class="btn btn-outline-primary-2 btn-order btn-block">PROCEED TO CHECKOUT</a>
                                        <% } else { %>
                                        <p class="text-center text-muted">Your cart is empty. Please <a href="/shop">choose items</a> from the shop.</p>
                                        <% } %>
                                    </div>
                                    <a href="/shop" class="btn btn-outline-dark-2 btn-block mb-3"><span>CONTINUE SHOPPING</span><i class="icon-refresh"></i></a>
                                </aside>
                            </div>
                        </div>
                    </div>
                </div>
            </main>

            <footer class="footer">
                <!-- Footer content here -->
            </footer>
        </div>

        <!-- JavaScript and jQuery for handling real-time updates -->
        <script src="/assets/js/jquery.min.js"></script>
        <script src="/assets/js/bootstrap.bundle.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

        <script>
            const subtotalElement = document.getElementById("subtotal");
            const totalElement = document.getElementById("total");
            const shippingMessage = document.getElementById("shipping-message");
            const product_subtotal = document.getElementById("product-subtotal");

            const updateCartTotals = () => {
                let subtotal = 0;
                const quantityInputs = document.querySelectorAll(".quantity-input");

                quantityInputs.forEach((input) => {
                    const price = parseFloat(input.closest("tr").querySelector(".price-col").textContent.replace("$", ""));
                    const quantity = parseInt(input.value, 10);
                    subtotal += price * quantity;
                });

                const shippingCost = subtotal >= 1500 ? 0 : 50;
                const total = subtotal + shippingCost;

                subtotalElement.textContent = `$${subtotal.toFixed(2)}`;
                product_subtotal.textContent = `$${subtotal.toFixed(2)}`;
                totalElement.textContent = `$${total.toFixed(2)}`;
                shippingMessage.textContent = shippingCost === 0 ? "Free Shipping" : `$${shippingCost.toFixed(2)}`;
            };

            document.querySelectorAll(".quantity-input").forEach((input) => {
                input.addEventListener("input", async (event) => {
                    const stock = parseInt(input.getAttribute("data-stock"), 10);
                    const quantity = parseInt(input.value, 10);
                    const productId = input.closest("tr").getAttribute("data-product-id");

                    // Check stock limits
                    if (quantity > stock) {
                        Swal.fire({
                            title: "Max Stock Reached",
                            text: `There are only ${stock} items available in stock.`,
                            icon: "error",
                            confirmButtonText: "OK",
                        });
                        input.value = stock;
                    }

                    // Prevent decreasing below 1
                    if (quantity < 1) {
                        input.value = 1;
                    }

                    // Update cart in the database via AJAX
                    try {
                        console.log("INPUT.VALUE : ", input.value);

                        const response = await axios.post(`/cart/update`, {
                            productId: productId,
                            quantity: input.value,
                        });

                        if (response.data.success) {
                            updateCartTotals();
                        } else {
                            Swal.fire({
                                title: "Error",
                                text: response.data.message,
                                icon: "error",
                                confirmButtonText: "Try Again",
                            });
                        }
                    } catch (error) {
                        console.error("Error updating cart:", error);
                        Swal.fire({
                            title: "Error",
                            text: error.response.data.message,
                            icon: "error",
                            confirmButtonText: "OK",
                        });
                    }
                });
            });

            document.querySelectorAll(".btn-remove").forEach((button) => {
                button.addEventListener("click", async (event) => {
                    const productId = button.getAttribute("data-product-id");

                    Swal.fire({
                        title: "Are you sure?",
                        text: "Do you want to remove this item from the cart?",
                        icon: "warning",
                        showCancelButton: true,
                        confirmButtonText: "Yes, remove it!",
                        cancelButtonText: "No, keep it",
                    }).then(async (result) => {
                        if (result.isConfirmed) {
                            try {
                                const response = await axios.post(`/cart/remove-item`, {
                                    productId: productId,
                                });

                                if (response.data.success) {
                                    button.closest("tr").remove();
                                    updateCartTotals();

                                    Swal.fire({
                                        title: "Removed",
                                        text: "Item removed from the cart.",
                                        icon: "success",
                                        confirmButtonText: "OK",
                                    });
                                } else {
                                    Swal.fire({
                                        title: "Error",
                                        text: response.data.message,
                                        icon: "error",
                                        confirmButtonText: "Try Again",
                                    });
                                }
                            } catch (error) {
                                console.error("Error removing item:", error);
                                Swal.fire({
                                    title: "Error",
                                    text: "Failed to remove the item.",
                                    icon: "error",
                                    confirmButtonText: "OK",
                                });
                            }
                        }
                    });
                });
            });

            // Initial update of the totals
            updateCartTotals();
        </script>
    </body>
</html>
